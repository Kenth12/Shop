{% extends "base.html" %}

{% block title %}{{ action }} venta{% endblock %}

{% block content %}
<section class="card">
  <h2>{{ action }} venta</h2>
  <form method="post" class="form-grid">
    <label for="product_id">Producto</label>
    <select id="product_id" name="product_id">
      <option value="">— Seleccione producto —</option>
      {% for p in products %}
      <option value="{{ p.id }}" data-price="{{ p.price }}" {% if sale and sale.product_id and sale.product_id == p.id %}selected{% elif sale and not sale.product_id and sale.product == p.name %}selected{% endif %}>{{ p.name }} {% if p.sku %}({{ p.sku }}){% endif %} - {{ p.stock }} disponibles</option>
      {% endfor %}
    </select>

    <fieldset class="full">
      <legend>Información del cliente</legend>

      <label for="customer_name">Nombre</label>
      <input
        type="text"
        id="customer_name"
        name="customer_name"
        value="{{ sale.customer.name if sale and sale.customer else '' }}"
      />

      <label for="customer_email">Email</label>
      <input
        type="email"
        id="customer_email"
        name="customer_email"
        value="{{ sale.customer.email if sale and sale.customer else '' }}"
      />

      <label for="customer_phone">Teléfono</label>
      <input
        type="tel"
        id="customer_phone"
        name="customer_phone"
        value="{{ sale.customer.phone if sale and sale.customer else '' }}"
      />
    </fieldset>

    <label for="quantity">Cantidad</label>
    <input
      type="number"
      min="1"
      id="quantity"
      name="quantity"
      value="{{ sale.quantity if sale else 1 }}"
      required
    />

    <label for="price">Precio</label>
    <input
      type="number"
      step="0.01"
      min="0"
      id="price"
      name="price"
      value="{{ sale.price if sale else '' }}"
      required
    />

    <div class="actions full">
      <a class="button ghost" href="{{ url_for('sales_list') }}">Cancelar</a>
      <button class="button primary" type="submit">{{ action }}</button>
    </div>
  </form>
</section>
<script>
  // Autofill price when selecting a product
  (function(){
    const sel = document.getElementById('product_id');
    const priceInput = document.getElementById('price');
    if(!sel || !priceInput) return;
    sel.addEventListener('change', function(){
      const opt = sel.options[sel.selectedIndex];
      const p = opt ? opt.getAttribute('data-price') : '';
      if(p !== null && p !== ''){
        priceInput.value = parseFloat(p).toFixed(2);
      }
    });
  })();
</script>
{% endblock %}

